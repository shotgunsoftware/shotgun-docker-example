version: '2'
services:
  ##################################################################
  app:
    image: shotgun-app:%VERSION%
    ports:
      - "<network_interface_ip>:80:80"
    environment:
      SHOTGUN_SITE_URL: shotgun.mystudio.test
      POSTGRES_HOST: db            # Hostname or DB container name
      POSTGRES_DB: shotgun
      POSTGRES_PORT: 5432
      POSTGRES_USER: shotgun
      #POSTGRES_PASSWORD: dummy
      MEMCACHED_HOST: memcached    # Hostname or memcached container name
      MEMCACHED_PORT: 11211
    labels:
      com.shotgunsoftware.component: app
    volumes:
      - ../media:/media
    depends_on:
      - db
      - memcached
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "<network_interface_ip>:24224"
        tag: "sg.app.{{.ID}}"
    networks:
      default:
        aliases:
          - shotgun.mystudio.test
    restart: always
 ##################################################################
  # emailnotifier:
  #   image: shotgun-app:%VERSION%
  #   command: sg_run_email_notifier
  #   environment:
  #     SHOTGUN_SITE_URL: shotgun.mystudio.test
  #     POSTGRES_HOST: db          # Hostname or DB container name
  #     POSTGRES_DB: shotgun
  #     POSTGRES_PORT: 5432
  #     POSTGRES_USER: shotgun
  #     #POSTGRES_PASSWORD: dummy
  #   labels:
  #     com.shotgunsoftware.component: emailnotifier
  #   depends_on:
  #     - db
  #     - memcached
  #   restart: always
  ##################################################################
  memcached:
    image: memcached:1.4-alpine
    restart: always
  ##################################################################
  db:
    image: postgres:9.6
    environment:
      POSTGRES_USER: shotgun
      PGDATA: /var/lib/postgresql/data
    restart: always
    volumes:
      - ../pgdata:/var/lib/postgresql/data
  ##################################################################
  dbops:
    image: postgres:9.6
    command: ["/bin/bash"]
    stdin_open: true
    tty: true
    environment:
      PGHOST: db
      PGPORT: 5432
      PGUSER: shotgun
      PGDATABASE: shotgun
      PGOPTIONS: "-c statement_timeout=0"
      #PGPASSWORD: dummy
    labels:
      com.shotgunsoftware.component: dbops
    volumes:
      - ../db_backup:/db_backup
    restart: always
  ##################################################################
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:6.2.1
    ports:
      - "9200:9200"
    volumes:
      - data_es:/usr/share/elasticsearch/data
    ulimits:
      memlock: -1
  ##################################################################
  kibana:
    build: ../kibana
    ports:
      - "5601:5601"
    links:
      - elasticsearch
    volumes:
      - data_kb:/usr/share/kibana/data
  ##################################################################
  fluentd:
    build: ../fluentd
    ports:
      - "24224:24224"
    links:
      - elasticsearch
    volumes:
      - ../fluentd/files_docker/fluent.conf:/fluentd/etc/fluent.conf:ro
      - ../logs:/var/log/shotgun
##################################################################
volumes:
  data_es:
  data_kb: